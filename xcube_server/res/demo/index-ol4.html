<!doctype html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <link rel="stylesheet" href="../css/ol-layerswitcher.css" type="text/css"/>
    <style>
      html, body, #map {
          width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
      }
    </style>
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js" type="text/javascript"></script>
    <script src="../js/xcube-ol4.js" type="text/javascript"></script>
    <script src="../js/ol-layerswitcher.js" type="text/javascript"></script>
    <title>xcube Tile Server Demo</title>
</head>
<body>
<div id="map" class="map">
    <div style="height: 24px; padding: 4px; margin: 4px; position: absolute; bottom: 0px; z-index:100">
        <button id="play" disabled="true" type="button">Play</button>
        <button id="pause" disabled="true" type="button">Pause</button>
        <span id="info"></span>
    </div>
</div>
<script type="text/javascript">

    var overlayGroup = new ol.layer.Group({
        title: 'Layers',
        layers: [
        ]
    });

    var map = new ol.Map({
        target: 'map',
        layers: [
            /*
            new ol.layer.Tile({
                source: new ol.source.BingMaps({
                    key: 'AnCcpOxnAAgq-KyFcczSZYZ_iFvCOmWl0Mx-6QzQ_rzMtpgxZrPZZNxa8_9ZNXci',
                    imagerySet: "Aerial",
                    reprojectionErrorThreshold: 2.5,
                }),
            }),
            */
            // new ol.layer.Tile({source: new ol.source.Stamen({layer: 'terrain'})}),
            new ol.layer.Tile({source: new ol.source.OSM()}),
            overlayGroup
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([2.5, 51.25]),
            zoom: 7
        })
    });

    var datasetName = 'remote';
    var layerSourceOptions = null;
    var animationId = null;
    var frameRate = 0.5; // frames per second
    var baseTileUrl = null;
    var timeValues = null;
    var timeValue = null;
    var timeIndex = 0;
    var variables = []

    fetch('http://localhost:8080/xcube/variables/' + datasetName + '.json')
    .then(response => response.json())
    .then(tileSourceOptions => {
        variables = tileSourceOptions.variables
        for(var variable of variables){
            var variableName = variable.name
            console.log('variableName', variableName)
            fetch('http://localhost:8080/xcube/tilegrid/' + datasetName + '/' + variableName + '/ol4.json')
            .then(response => response.json())
            .then(options => {
                layerSourceOptions = options;
                console.log('before push', variableName)
                overlayGroup.getLayers().push(
                    new ol.layer.Tile({
                        title: variableName,
                        source: newTileXYZSourceFromJsonOptions(layerSourceOptions)
                    })
                )
                //map.addLayer(new ol.layer.Tile({source: newTileXYZSourceFromJsonOptions(layerSourceOptions)})); 
                return fetch('http://localhost:8080/xcube/coords/' + datasetName + '/time.json');
            })
            .then(response => response.json())
            .then(coords => {
                timeValues = coords.values;
                console.log(timeValues);
                initAnimation(); 
            });
        }
    })

    

    function updateTimeInfo() {
        var info = document.getElementById('info');
        if (timeValue) {
            html = timeValue;
            html += ', step ' + timeIndex + " of " + timeValues.length;
        } else {
            html = 'YYYY-DD-HH';
        }
        info.innerHTML = "<strong>" + html + "</strong>";
    }

    function onNewTime() {
        if (timeValues === null || timeValues.length === 0) {
            return null;
        }
        timeIndex += 1;
        timeValue = timeValues[timeIndex % timeValues.length]
        if (!timeValue) {
            return;
        }
        updateTimeInfo();

        var newLayerSourceOptions = {...layerSourceOptions, url: layerSourceOptions.url + '?time=' + timeValue};
        var layer = overlayGroup.getLayers().getArray()[0];
        layer.setSource(newTileXYZSourceFromJsonOptions(newLayerSourceOptions));
    }

    function setButtonEnabled(id, enabled) {
        var button = document.getElementById(id);
        button.disabled = !enabled;
    }

    function initAnimation() {

        function stop() {
            if (animationId !== null) {
                window.clearInterval(animationId);
                animationId = null;                
            }
            setButtonEnabled('play', true);
            setButtonEnabled('pause', false);
        }

        function play() {
            stop();
            animationId = window.setInterval(onNewTime, 1000 / frameRate);
            setButtonEnabled('play', false);
            setButtonEnabled('pause', true);
        }

        var startButton = document.getElementById('play');
        startButton.disabled = false;
        startButton.addEventListener('click', play, false);

        var stopButton = document.getElementById('pause');
        stopButton.disabled = true;
        stopButton.addEventListener('click', stop, false);

        updateTimeInfo();
    }

    var layerSwitcher = new ol.control.LayerSwitcher({
        title: 'test',
        tipLabel: 'LÃ©gende' // Optional label for button
    });
    map.addControl(layerSwitcher);

</script>
</body>
</html>
